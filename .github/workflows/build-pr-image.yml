name: Build PR Image

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to build images from"
        required: true
        type: number
      app:
        description: "Which app to build"
        required: true
        type: choice
        options:
          - go-server
          - rust-server
          - both

concurrency:
  group: pr-build-${{ github.event.inputs.pr_number }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  resolve-pr:
    runs-on: ubuntu-latest
    outputs:
      pr_sha: ${{ steps.pr.outputs.sha }}
      pr_ref: ${{ steps.pr.outputs.ref }}
    steps:
      - name: Get PR info
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_DATA=$(gh api repos/${{ github.repository }}/pulls/${{ inputs.pr_number }})
          echo "sha=$(echo "$PR_DATA" | jq -r .head.sha)" >> "$GITHUB_OUTPUT"
          echo "ref=$(echo "$PR_DATA" | jq -r .head.ref)" >> "$GITHUB_OUTPUT"

  build-and-push:
    needs: resolve-pr
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: ${{ fromJSON(inputs.app == 'both' && '["go-server","rust-server"]' || format('["{0}"]', inputs.app)) }}
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout PR
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.resolve-pr.outputs.pr_sha }}

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: rust-server-vs-goserver/${{ matrix.app }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.app }}:pr-${{ inputs.pr_number }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.app }}:${{ needs.resolve-pr.outputs.pr_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Comment on PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ inputs.pr_number }} \
            --repo ${{ github.repository }} \
            --body "üê≥ Image built and pushed for **${{ matrix.app }}**:
          \`\`\`
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.app }}:pr-${{ inputs.pr_number }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.app }}:${{ needs.resolve-pr.outputs.pr_sha }}
          \`\`\`
          Built from commit \`${{ needs.resolve-pr.outputs.pr_sha }}\` on branch \`${{ needs.resolve-pr.outputs.pr_ref }}\`"
